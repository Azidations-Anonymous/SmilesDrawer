<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>SmilesDrawer 2.0</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.3/css/bulma.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css"
        integrity="sha512-KfkfwYDsLkIlwQp6LFnl8zNdLGxu9YAA1QvwINks4PhcElQSvqcyVLLD9aMhXd13uQjoXtEKNosOWaZqXgel0g=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script type="text/javascript" src="smiles-drawer.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tweakpane@3.0.8/dist/tweakpane.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-beautify/1.14.3/beautify.min.js"
        integrity="sha512-16ZUuuM/OceXU7i8U6zQqtDsG+PCKcWX9XlmNN0z+lqUlBMzDmIzrKt6TOmW48EAU47XIU6Spaelz8tM9LgGKQ=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <style>
        .render-wrapper {
            position: relative;
        }

        .download-button {
            position: absolute;
            bottom: 12px;
            right: 12px;
        }

        .render-toggle {
            margin-top: 0.5rem;
        }

        .render-toggle .button.is-selected {
            pointer-events: none;
        }

        .render-wrapper svg,
        .render-wrapper canvas {
            width: 100%;
            height: auto;
            display: block;
        }

        #smiles-layout {
            padding-right: 0;
            transition: padding-right 0.2s ease;
        }
    </style>
</head>

<body>
    <section class="section">
        <div class="container" id="smiles-layout">
            <h1 class="title">
                SmilesDrawer 2.0
            </h1>
            <p class="subtitle">
                No server, no images, no templates, just a SMILES ðŸ˜Š
            </p>
            Using for academic work? Please <b>cite</b>: <a
                href="https://doi.org/10.1021/acs.jcim.7b00425">10.1021/acs.jcim.7b00425</a>
            <br />
            <br />

            <a class="button is-small" href="https://smilesdrawer.surge.sh/index.html">Home</a>
            <a class="button is-small" href="https://smilesdrawer.surge.sh/use.html">Use</a>
            <a class="button is-small" href="playground.html">Playground</a>
            <a class="button is-small" href="https://github.com/reymond-group/smilesDrawer">
                <span class="icon">
                    <i class="fab fa-github"></i>
                </span>
                <span>Source</span>
            </a>
            <br />
            <br />

            <div class="field">
                <label class="label is-small">Theme</label>
                <div class="control has-icons-left">
                    <div class="select is-small">
                        <select id="theme-selector">
                            <option selected>custom</option>
                            <option>light</option>
                            <option>dark</option>
                            <option>oldschool</option>
                            <option>solarized</option>
                            <option>solarized-dark</option>
                            <option>matrix</option>
                            <option>github</option>
                            <option>carbon</option>
                            <option>cyberpunk</option>
                            <option>gruvbox</option>
                            <option>gruvbox-dark</option>
                        </select>
                    </div>
                    <span class="icon is-small is-left">
                        <i class="fas fa-swatchbook"></i>
                    </span>
                </div>
            </div>
            <br />

            <div class="tile is-ancestor">
                <div class="tile is-vertical is-12">
                    <div class="tile">
                        <div class="tile is-parent">
                            <article class="tile is-child notification" id="primary-smiles-box">
                                <p class="title">Custom SMILES #1</p>
                                <input id="input-1" class="input" type="text" placeholder="Custom SMILES"
                                    value="OC(C(=O)O[C@H]1C[N+]2(CCCOC3=CC=CC=C3)CCC1CC2)(C1=CC=CS1)C1=CC=CS1">
                                <div class="content" style="overflow-x: auto; overflow-y: auto">
                                    <div class="render-wrapper">
                                        <svg id="display-1-svg"
                                            data-smiles="OC(C(=O)O[C@H]1C[N+]2(CCCOC3=CC=CC=C3)CCC1CC2)(C1=CC=CS1)C1=CC=CS1"></svg>
                                        <canvas id="display-1-canvas" width="500" height="500" style="display: none;"></canvas>
                                        <button class="button is-small download-button" data-download-target="display-1">
                                            Download
                                        </button>
                                    </div>
                                    <div class="field has-addons render-toggle" data-toggle-target="display-1">
                                        <p class="control">
                                            <button class="button is-small is-link is-selected" data-render-mode="svg">
                                                SVG
                                            </button>
                                        </p>
                                        <p class="control">
                                            <button class="button is-small" data-render-mode="png">
                                                PNG
                                            </button>
                                        </p>
                                    </div>
                                </div>
                            </article>
                        </div>
                    </div>
                    <div class="tile is-parent">
                        <article class="tile is-child notification">
                            <p class="title">Custom SMILES #3</p>
                            <input id="input-3" class="input" type="text" placeholder="Custom SMILES"
                                value="C=CCBr.[Na+].[I-]>CC(=O)C>C=CCI.[Na+].[Br-]  __{'textBelowArrow': '90%'}__">
                            <div class="content" style="overflow-x: auto">
                                <div class="render-wrapper">
                                    <svg id="display-3-svg"
                                        data-smiles="C=CCBr.[Na+].[I-]>CC(=O)C>C=CCI.[Na+].[Br-]  __{'textBelowArrow': '90%'}__"></svg>
                                    <button class="button is-small download-button" data-download-target="display-3">
                                        Download
                                    </button>
                                </div>
                            </div>
                        </article>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <section class="section pt-0">
        <div class="container">
            <h2 class="title is-5">Runtime Log</h2>
            <textarea id="runtime-log" class="textarea is-family-monospace" rows="12" readonly>
[console]
            </textarea>
        </div>
    </section>

    <div id="export-modal" class="modal">
        <div class="modal-background"></div>
        <div class="modal-card">
            <header class="modal-card-head">
                <p class="modal-card-title">Options export</p>
                <button class="delete" aria-label="close"></button>
            </header>
            <section class="modal-card-body">
                <div class="field">
                    <label class="label">Molecule Options</label>
                    <div class="control">
                        <textarea id="molecule-options" class="textarea is-small"
                            placeholder="Molecule options"></textarea>
                    </div>
                </div>

                <div class="field">
                    <label class="label">Reaction Options</label>
                    <div class="control">
                        <textarea id="reaction-options" class="textarea is-small"
                            placeholder="Reaction options"></textarea>
                    </div>
                </div>
            </section>
            <footer class="modal-card-foot">
                <button class="button">Close</button>
            </footer>
        </div>
    </div>

    <script>
        const pane = new Tweakpane.Pane();
        const paneElement = pane?.element ?? null;
        const paneAnchor = document.getElementById('primary-smiles-box');
        const layoutContainer = document.getElementById('smiles-layout');

        function updateLayoutPadding() {
            if (!layoutContainer || !paneElement) {
                return;
            }
            const { width } = paneElement.getBoundingClientRect();
            layoutContainer.style.paddingRight = `${Math.ceil(width)}px`;
            alignPaneTop();
        }

        function alignPaneTop() {
            if (!paneElement || !paneAnchor) {
                return;
            }

            const anchorBounds = paneAnchor.getBoundingClientRect();
            const offsetTop = anchorBounds.top + window.pageYOffset;
            paneElement.style.position = 'absolute';
            paneElement.style.right = '24px';
            paneElement.style.top = `${offsetTop}px`;
        }

        if ('ResizeObserver' in window) {
            if (paneElement) {
                const paneObserver = new ResizeObserver(updateLayoutPadding);
                paneObserver.observe(paneElement);
            }
            if (paneAnchor) {
                const anchorObserver = new ResizeObserver(alignPaneTop);
                anchorObserver.observe(paneAnchor);
            }
        }

        window.addEventListener('resize', updateLayoutPadding);
        window.addEventListener('scroll', alignPaneTop, { passive: true });
        updateLayoutPadding();
        alignPaneTop();

        const logBuffer = [];
        const runtimeLog = document.getElementById('runtime-log');
        const originalConsoleLog = console.log.bind(console);
        console.log = function (...args) {
            const message = args.map((arg) => {
                if (typeof arg === 'object') {
                    try {
                        return JSON.stringify(arg);
                    } catch (err) {
                        return String(arg);
                    }
                }
                return String(arg);
            }).join(' ');
            logBuffer.push(message);
            runtimeLog.value = logBuffer.slice(-200).join('\n');
            runtimeLog.scrollTop = runtimeLog.scrollHeight;
            originalConsoleLog(...args);
        };

        const logCurrentOptions = () => {
            try {
                const snapshot = {
                    moleculeOptions: JSON.parse(JSON.stringify(moleculeOptions)),
                    reactionOptions: JSON.parse(JSON.stringify(reactionOptions)),
                };
                logBuffer.length = 0;
                console.log('[current-options]\n' + JSON.stringify(snapshot, null, 2));
            } catch (err) {
                console.error('Failed to capture current options', err);
            }
        };

        logCurrentOptions();

        let theme = 'custom';

        let reactionOptions = {
            fontSize: 9,
            fontFamily: 'Arial, Helvetica, sans-serif',
            spacing: 10,
            plus: {
                size: 9,
                thickness: 1
            },
            arrow: {
                length: 120,
                headSize: 6.0,
                thickness: 1.0,
                margin: 3
            }
        }

        let moleculeOptions = {
            meta: {
                version: '3.0.0',
                schemaRevision: 1,
                debug: false,
                debugTextOutline: 3
            },
            canvas: {
                width: 500,
                height: 500,
                scale: 0.0,
                padding: 2.0
            },
            rendering: {
                bonds: {
                    bondThickness: 1.0,
                    bondLength: 30,
                    shortBondLength: 0.8,
                    bondSpacing: 0.17 * 30,
                    dashPattern: [3, 2],
                    tripleBondSpacingDivider: 1.5,
                    dashedStepFactor: 1.25,
                    dashedWedgeSpacingMultiplier: 3.0,
                    dashedWidthFactorSvg: 0.5,
                    dashedWidthFactorCanvas: 1.5,
                    dashedColorSwitchThreshold: 0.5,
                    dashedInsetPx: 1.0
                },
                stereochemistry: {
                    isomeric: true,
                    shadowShortenPx: 5.0,
                    wedgeTipPaddingPx: 3.0,
                    wedgeTipFontScale: 0.25,
                    wedgeSidePaddingPx: 1.5
                },
                atoms: {
                    atomVisualization: 'default',
                    terminalCarbons: false,
                    explicitHydrogens: true,
                    pointRadius: 6.666666666666667,
                    pointMaskRadius: 1.5
                },
                aromatic: {
                    piSystemInset: 7,
                    overlayInset: 7,
                    overlayClampRatio: 0.5,
                    overlayColor: 'C'
                }
            },
            layout: {
                graph: {
                    compactDrawing: true,
                    overlapSensitivity: 0.42,
                    overlapResolutionIterations: 1,
                    defaultBranchAngleRad: (2 * Math.PI) / 3,
                    linearBondToleranceRad: 0.1,
                    rotationSnapIncrementDeg: 30,
                    rotationSnapDeadzoneDeg: 15,
                    finetuneRotationOffsetDeg: 1,
                    centerOfMassRadiusFactor: 2.0,
                    rotationJitterEpsilon: 0.001
                },
                finetune: {
                    enabled: true,
                    maxSteps: 256,
                    maxDurationMs: 250
                },
                force: {
                    kkThreshold: 0.1,
                    kkInnerThreshold: 0.1,
                    kkMaxIteration: 20000,
                    kkMaxInnerIteration: 50,
                    kkMaxEnergy: 1e9,
                    hessianMinimum: 0.1
                },
                overlap: {
                    ringDivisionSegments: 6,
                    finetuneClashDistanceFactor: 0.8,
                    rotatableEdgeCenteringFactor: 0.5,
                    terminalPushAngleDeg: 20
                }
            },
            typography: {
                fontFamily: 'Arial, Helvetica, sans-serif',
                fontSizeLarge: 11,
                fontSizeSmall: 3,
                labelOutlineWidth: 1,
                svgBaselineShiftEm: 0.35,
                measurementLineHeight: 0.9,
                isotopeOffsetFactor: 0.5,
                labelSpacing: {
                    baseUnitScale: 0.1,
                    chargeMultiplier: 0.5,
                    isotopeMultiplier: 1.0,
                    hydrogenMultiplier: 1.0,
                    hydrogenCountMultiplier: 0.0
                }
            },
            annotations: {
                enabled: false,
                color: '#ff4081',
                fontSize: 9,
                offset: 12,
                formatter: null,
                mask: {
                    baseScale: 0.8,
                    wideScale: 0.8,
                    canvasRadiusFactor: 2 / 3
                }
            },
            visualizations: {
                weights: {
                    colormap: null,
                    additionalPadding: 20.0,
                    sigma: 10,
                    interval: 0.0,
                    opacity: 1.0
                },
                gaussianDefaults: {
                    defaultSigma: 0.3,
                    domainMin: -1.0,
                    domainMax: 1.0,
                    defaultColormap: [
                        '#c51b7d',
                        '#de77ae',
                        '#f1b6da',
                        '#fde0ef',
                        '#ffffff',
                        '#e6f5d0',
                        '#b8e186',
                        '#7fbc41',
                        '#4d9221'
                    ]
                }
            },
            reactions: {
                scale: null,
                spacing: {
                    bondLengthMultiplier: 10 / 30
                },
                font: {
                    scale: 0.8,
                    family: null
                },
                plus: {
                    sizeBondLengthMultiplier: 9 / 30,
                    thicknessBondThicknessMultiplier: 1.0
                },
                arrow: {
                    lengthBondLengthMultiplier: 4.0,
                    headSizeBondLengthMultiplier: 6 / 30,
                    thicknessBondThicknessMultiplier: 1.0,
                    marginBondLengthMultiplier: 3 / 30
                },
                weights: {
                    normalize: false
                }
            },
            appearance: {
                themes: {
                    dark: {
                        C: '#fff',
                        O: '#e74c3c',
                        N: '#3498db',
                        F: '#27ae60',
                        CL: '#16a085',
                        BR: '#d35400',
                        I: '#8e44ad',
                        P: '#d35400',
                        S: '#f1c40f',
                        B: '#e67e22',
                        SI: '#e67e22',
                        H: '#aaa',
                        BACKGROUND: '#141414'
                    },
                    light: {
                        C: '#222',
                        O: '#e74c3c',
                        N: '#3498db',
                        F: '#27ae60',
                        CL: '#16a085',
                        BR: '#d35400',
                        I: '#8e44ad',
                        P: '#d35400',
                        S: '#f1c40f',
                        B: '#e67e22',
                        SI: '#e67e22',
                        H: '#666',
                        BACKGROUND: '#fff'
                    },
                    oldschool: {
                        C: '#000',
                        O: '#000',
                        N: '#000',
                        F: '#000',
                        CL: '#000',
                        BR: '#000',
                        I: '#000',
                        P: '#000',
                        S: '#000',
                        B: '#000',
                        SI: '#000',
                        H: '#000',
                        BACKGROUND: '#fff'
                    },
                    "solarized": {
                        C: "#586e75",
                        O: "#dc322f",
                        N: "#268bd2",
                        F: "#859900",
                        CL: "#16a085",
                        BR: "#cb4b16",
                        I: "#6c71c4",
                        P: "#d33682",
                        S: "#b58900",
                        B: "#2aa198",
                        SI: "#2aa198",
                        H: "#657b83",
                        BACKGROUND: "#fff"
                    },
                    "solarized-dark": {
                        C: "#93a1a1",
                        O: "#dc322f",
                        N: "#268bd2",
                        F: "#859900",
                        CL: "#16a085",
                        BR: "#cb4b16",
                        I: "#6c71c4",
                        P: "#d33682",
                        S: "#b58900",
                        B: "#2aa198",
                        SI: "#2aa198",
                        H: "#839496",
                        BACKGROUND: "#fff"
                    },
                    "matrix": {
                        C: "#678c61",
                        O: "#2fc079",
                        N: "#4f7e7e",
                        F: "#90d762",
                        CL: "#82d967",
                        BR: "#23755a",
                        I: "#409931",
                        P: "#c1ff8a",
                        S: "#faff00",
                        B: "#50b45a",
                        SI: "#409931",
                        H: "#426644",
                        BACKGROUND: "#fff"
                    },
                    "github": {
                        C: "#24292f",
                        O: "#cf222e",
                        N: "#0969da",
                        F: "#2da44e",
                        CL: "#6fdd8b",
                        BR: "#bc4c00",
                        I: "#8250df",
                        P: "#bf3989",
                        S: "#d4a72c",
                        B: "#fb8f44",
                        SI: "#bc4c00",
                        H: "#57606a",
                        BACKGROUND: "#fff"
                    },
                    "carbon": {
                        C: "#161616",
                        O: "#da1e28",
                        N: "#0f62fe",
                        F: "#198038",
                        CL: "#007d79",
                        BR: "#fa4d56",
                        I: "#8a3ffc",
                        P: "#ff832b",
                        S: "#f1c21b",
                        B: "#8a3800",
                        SI: "#e67e22",
                        H: "#525252",
                        BACKGROUND: "#fff"
                    },
                    "cyberpunk": {
                        C: "#ea00d9",
                        O: "#ff3131",
                        N: "#0abdc6",
                        F: "#00ff9f",
                        CL: "#00fe00",
                        BR: "#fe9f20",
                        I: "#ff00ff",
                        P: "#fe7f00",
                        S: "#fcee0c",
                        B: "#ff00ff",
                        SI: "#ffffff",
                        H: "#913cb1",
                        BACKGROUND: "#fff"
                    },
                    "gruvbox": {
                        C: "#665c54",
                        O: "#cc241d",
                        N: "#458588",
                        F: "#98971a",
                        CL: "#79740e",
                        BR: "#d65d0e",
                        I: "#b16286",
                        P: "#af3a03",
                        S: "#d79921",
                        B: "#689d6a",
                        SI: "#427b58",
                        H: "#7c6f64",
                        BACKGROUND: "#fbf1c7"
                    },
                    "gruvbox-dark": {
                        C: "#ebdbb2",
                        O: "#cc241d",
                        N: "#458588",
                        F: "#98971a",
                        CL: "#b8bb26",
                        BR: "#d65d0e",
                        I: "#b16286",
                        P: "#fe8019",
                        S: "#d79921",
                        B: "#8ec07c",
                        SI: "#83a598",
                        H: "#bdae93",
                        BACKGROUND: "#282828"
                    },
                    custom: {
                        C: '#222',
                        O: '#e74c3c',
                        N: '#3498db',
                        F: '#27ae60',
                        CL: '#16a085',
                        BR: '#d35400',
                        I: '#8e44ad',
                        P: '#d35400',
                        S: '#f1c40f',
                        B: '#e67e22',
                        SI: '#e67e22',
                        H: '#666',
                        BACKGROUND: '#fff'
                    }
                },
                highlights: {
                    fallbackColor: '#03fc9d',
                    fallbackRadiusFactor: 1 / 3
                }
            },
            pixelExport: {
                viewboxYOffset: -0.5
            }
        };

        let lastFixedCanvasScale = moleculeOptions.canvas.scale > 0 ? moleculeOptions.canvas.scale : 1.0;
        const dashPattern = moleculeOptions.rendering.bonds.dashPattern || [];
        const normalizeDashSegment = (value, fallback) => Number.isFinite(value) ? value : fallback;
        const uiState = {
            dynamicCanvasScale: moleculeOptions.canvas.scale <= 0,
            dashPatternOn: normalizeDashSegment(dashPattern[0], 3),
            dashPatternOff: normalizeDashSegment(dashPattern[1], 2),
            showAdvanced: false,
        };
        const syncDashPattern = () => {
            const existingPattern = moleculeOptions.rendering.bonds.dashPattern || [];
            const remainingSegments = existingPattern.length > 2 ? existingPattern.slice(2) : [];
            moleculeOptions.rendering.bonds.dashPattern = [
                uiState.dashPatternOn,
                uiState.dashPatternOff,
                ...remainingSegments
            ];
        };
        syncDashPattern();

        const advancedOnlyInputs = [];
        const exclusiveAdvancedFolders = new Set();
        const registerAdvancedInput = (folder, target, key, config, options = {}) => {
            const input = folder.addInput(target, key, config);
            input.hidden = !uiState.showAdvanced;
            advancedOnlyInputs.push({ input, folder });
            if (options.exclusive) {
                exclusiveAdvancedFolders.add(folder);
                folder.hidden = !uiState.showAdvanced;
            }
            return input;
        };
        const markFolderExclusive = (folder) => {
            exclusiveAdvancedFolders.add(folder);
            folder.hidden = !uiState.showAdvanced;
        };

        const applyAdvancedMode = (isAdvanced) => {
            if (paneElement) {
                paneElement.dataset.advancedMode = isAdvanced ? 'true' : 'false';
                paneElement.classList.toggle('is-advanced', !!isAdvanced);
            }
            uiState.showAdvanced = isAdvanced;
            advancedOnlyInputs.forEach(({ input }) => {
                input.hidden = !isAdvanced;
                input.refresh();
            });
            exclusiveAdvancedFolders.forEach((folder) => {
                folder.hidden = !isAdvanced;
            });
        };
        const advancedToggle = pane.addInput(uiState, 'showAdvanced', {
            label: 'Advanced mode',
        });
        advancedToggle.on('change', (event) => {
            applyAdvancedMode(!!event.value);
        });
        applyAdvancedMode(uiState.showAdvanced);

        const folderMeta = pane.addFolder({
            title: 'Meta',
            expanded: false,
        });
        moleculeOptions.rendering.stereochemistry.dashedSpacingMultiplier = moleculeOptions.rendering.bonds.dashedWedgeSpacingMultiplier;

        const folderCanvas = pane.addFolder({
            title: 'Canvas',
            expanded: false,
        });

        const folderRendering = pane.addFolder({
            title: 'Rendering',
            expanded: false,
        });

        const folderRenderingAtoms = folderRendering.addFolder({
            title: 'Atoms',
            expanded: false,
        });

        const folderRenderingBonds = folderRendering.addFolder({
            title: 'Bonds',
            expanded: false,
        });
        const folderRenderingStereochemistry = folderRendering.addFolder({
            title: 'Stereochemistry',
            expanded: false,
        });
        markFolderExclusive(folderRenderingStereochemistry);
        const folderRenderingAromatic = folderRendering.addFolder({
            title: 'Aromatic',
            expanded: false,
        });
        markFolderExclusive(folderRenderingAromatic);

        const folderLayout = pane.addFolder({
            title: 'Layout',
            expanded: false,
        });

        const folderLayoutGraph = folderLayout.addFolder({
            title: 'Graph',
            expanded: false,
        });

        const folderLayoutFinetune = folderLayout.addFolder({
            title: 'Finetune',
            expanded: false,
        });
        folderLayoutFinetune.hidden = !uiState.showAdvanced;

        const folderLayoutForce = folderLayout.addFolder({
            title: 'Force',
            expanded: false,
        });
        folderLayoutForce.hidden = !uiState.showAdvanced;

        const folderLayoutOverlap = folderLayout.addFolder({
            title: 'Overlap',
            expanded: false,
        });
        folderLayoutOverlap.hidden = !uiState.showAdvanced;

        const folderTypography = pane.addFolder({
            title: 'Typography',
            expanded: false,
        });

        const folderAppearance = pane.addFolder({
            title: 'Appearance',
            expanded: false,
        });

        const folderAppearanceTheme = folderAppearance.addFolder({
            title: 'Custom Theme',
            expanded: false,
        });
        markFolderExclusive(folderAppearanceTheme);

        const folderVisualizations = pane.addFolder({
            title: 'Visualizations',
            expanded: false,
        });
        markFolderExclusive(folderVisualizations);

        const folderReactions = pane.addFolder({
            title: 'Reactions',
            expanded: false,
        });
        markFolderExclusive(folderReactions);

        const folderReactionGeneral = folderReactions.addFolder({
            title: 'General',
            expanded: false,
        });
        markFolderExclusive(folderReactionGeneral);

        const folderReactionPlus = folderReactions.addFolder({
            title: 'Plus',
            expanded: false,
        });
        markFolderExclusive(folderReactionPlus);

        const folderReactionArrow = folderReactions.addFolder({
            title: 'Arrow',
            expanded: false,
        });
        markFolderExclusive(folderReactionArrow);

        const folderExport = pane.addFolder({
            title: 'Export',
            expanded: false,
        });

        folderMeta.addMonitor(moleculeOptions.meta, 'version', {
            label: 'Version'
        });
        folderMeta.addMonitor(moleculeOptions.meta, 'schemaRevision', {
            label: 'Schema revision'
        });
        const debugInput = folderMeta.addInput(moleculeOptions.meta, 'debug');
        const debugOutlineInput = folderMeta.addInput(moleculeOptions.meta, 'debugTextOutline', {
            label: 'Debug outline width',
            min: 0,
            max: 10,
            step: 0.1
        });
        const syncDebugOutlineVisibility = () => {
            debugOutlineInput.hidden = !moleculeOptions.meta.debug;
            debugOutlineInput.refresh();
        };
        debugInput.on('change', (event) => {
            moleculeOptions.meta.debug = event.value;
            syncDebugOutlineVisibility();
        });
        syncDebugOutlineVisibility();

        folderCanvas.addInput(moleculeOptions.canvas, 'width', {
            label: 'Width',
            min: 50,
            max: 5000,
            step: 1
        });
        folderCanvas.addInput(moleculeOptions.canvas, 'height', {
            label: 'Height',
            min: 50,
            max: 5000,
            step: 1
        });
        folderCanvas.addInput(moleculeOptions.canvas, 'padding', {
            label: 'Padding',
            min: 0,
            max: 200,
            step: 0.5
        });
        const dynamicScaleInput = folderCanvas.addInput(uiState, 'dynamicCanvasScale', {
            label: 'Dynamic size'
        });

        const canvasScaleInput = folderCanvas.addInput(moleculeOptions.canvas, 'scale', {
            step: 0.1,
            min: 0.0,
            max: 5.0,
        });

        const atomVisualizationInput = folderRenderingAtoms.addInput(moleculeOptions.rendering.atoms, 'atomVisualization', {
            options: {
                default: 'default',
                balls: 'balls',
                allballs: 'allballs'
            },
        });

        const pointRadiusInput = folderRenderingAtoms.addInput(moleculeOptions.rendering.atoms, 'pointRadius', {
            label: 'Point/Ball radius',
            min: 0,
            max: 10,
            step: 0.01
        });
        const pointStrokeWidthInput = folderRenderingAtoms.addInput(moleculeOptions.rendering.atoms, 'pointMaskRadius', {
            label: 'Point/Ball stroke width',
            min: 0,
            max: 50,
            step: 0.1
        });
        const updatePointInputVisibility = () => {
            const isDefaultMode = moleculeOptions.rendering.atoms.atomVisualization === 'default';
            pointRadiusInput.hidden = isDefaultMode;
            pointStrokeWidthInput.hidden = isDefaultMode;
        };
        atomVisualizationInput.on('change', updatePointInputVisibility);
        updatePointInputVisibility();
        folderRenderingAtoms.addInput(moleculeOptions.rendering.atoms, 'terminalCarbons', {
            label: 'Show terminal carbons'
        });
        folderRenderingAtoms.addInput(moleculeOptions.rendering.atoms, 'explicitHydrogens', {
            label: 'Explicit hydrogens'
        });

        folderRenderingBonds.addInput(moleculeOptions.rendering.bonds, 'bondThickness', {
            step: 0.1,
            min: 0.1,
            max: 5.0,
        });
        folderRenderingBonds.addInput(moleculeOptions.rendering.bonds, 'bondLength', {
            label: 'Bond length',
            step: 1,
            min: 5,
            max: 300,
        });
        folderRenderingBonds.addInput(moleculeOptions.rendering.bonds, 'shortBondLength', {
            step: 0.1,
            min: 0.1,
            max: 1.0,
        });
        folderRenderingBonds.addInput(moleculeOptions.rendering.bonds, 'bondSpacing', {
            step: 0.1,
            min: 0.0,
            max: 10.0,
        });
        folderRenderingBonds.addInput(moleculeOptions.rendering.bonds, 'tripleBondSpacingDivider', {
            label: 'Triple bond spacing divider',
            step: 0.1,
            min: 0.1,
            max: 10.0,
        });
        const dashedSpacingInput = folderRenderingBonds.addInput(moleculeOptions.rendering.bonds, 'dashedWedgeSpacingMultiplier', {
            label: 'Dashed wedge spacing multiplier',
            min: 0.1,
            max: 10.0,
            step: 0.1,
        });
        dashedSpacingInput.on('change', (event) => {
            moleculeOptions.rendering.stereochemistry.dashedSpacingMultiplier = event.value;
        });
        const folderRenderingBondsDash = folderRenderingBonds.addFolder({
            title: 'Aromatic dash pattern',
            expanded: false,
        });
        const dashPatternOnInput = folderRenderingBondsDash.addInput(uiState, 'dashPatternOn', {
            label: 'Dash length',
            min: 0,
            max: 50,
            step: 0.1,
        });
        dashPatternOnInput.on('change', (event) => {
            const sanitizedValue = Number.isFinite(event.value) ? Math.max(0, event.value) : 0;
            if (sanitizedValue !== uiState.dashPatternOn) {
                uiState.dashPatternOn = sanitizedValue;
                dashPatternOnInput.refresh();
            }
            syncDashPattern();
        });
        const dashPatternOffInput = folderRenderingBondsDash.addInput(uiState, 'dashPatternOff', {
            label: 'Gap length',
            min: 0,
            max: 50,
            step: 0.1,
        });
        dashPatternOffInput.on('change', (event) => {
            const sanitizedValue = Number.isFinite(event.value) ? Math.max(0, event.value) : 0;
            if (sanitizedValue !== uiState.dashPatternOff) {
                uiState.dashPatternOff = sanitizedValue;
                dashPatternOffInput.refresh();
            }
            syncDashPattern();
        });
        registerAdvancedInput(folderRenderingStereochemistry, moleculeOptions.rendering.stereochemistry, 'isomeric', {
            label: 'Enable stereochemistry',
        }, { exclusive: true });
        registerAdvancedInput(folderRenderingStereochemistry, moleculeOptions.rendering.stereochemistry, 'shadowShortenPx', {
            label: 'Shadow shorten (px)',
            min: 0,
            max: 50,
            step: 0.1,
        });
        registerAdvancedInput(folderRenderingStereochemistry, moleculeOptions.rendering.stereochemistry, 'wedgeTipPaddingPx', {
            label: 'Wedge tip padding (px)',
            min: 0,
            max: 20,
            step: 0.1,
        });
        registerAdvancedInput(folderRenderingStereochemistry, moleculeOptions.rendering.stereochemistry, 'wedgeTipFontScale', {
            label: 'Wedge tip font scale',
            min: 0,
            max: 1,
            step: 0.01,
        });
        registerAdvancedInput(folderRenderingStereochemistry, moleculeOptions.rendering.stereochemistry, 'wedgeSidePaddingPx', {
            label: 'Wedge side padding (px)',
            min: 0,
            max: 20,
            step: 0.1,
        });
        registerAdvancedInput(folderRenderingAromatic, moleculeOptions.rendering.aromatic, 'piSystemInset', {
            label: 'Pi system inset',
            min: 0,
            max: 20,
            step: 0.1,
        }, { exclusive: true });
        registerAdvancedInput(folderRenderingAromatic, moleculeOptions.rendering.aromatic, 'overlayInset', {
            label: 'Overlay inset',
            min: 0,
            max: 20,
            step: 0.1,
        });
        registerAdvancedInput(folderRenderingAromatic, moleculeOptions.rendering.aromatic, 'overlayClampRatio', {
            label: 'Overlay clamp ratio',
            min: 0,
            max: 1,
            step: 0.01,
        });
        registerAdvancedInput(folderRenderingAromatic, moleculeOptions.rendering.aromatic, 'overlayColor', {
            label: 'Overlay color',
            input: 'color',
        });
        folderLayoutGraph.addInput(moleculeOptions.layout.graph, 'compactDrawing', {
            label: 'Compact drawing',
        });
        registerAdvancedInput(folderLayoutGraph, moleculeOptions.layout.graph, 'overlapSensitivity', {
            label: 'Overlap sensitivity',
            min: 0,
            max: 5,
            step: 0.01,
        });
        registerAdvancedInput(folderLayoutGraph, moleculeOptions.layout.graph, 'overlapResolutionIterations', {
            label: 'Overlap resolution passes',
            min: 0,
            max: 25,
            step: 1,
        });
        registerAdvancedInput(folderLayoutGraph, moleculeOptions.layout.graph, 'rotationSnapIncrementDeg', {
            label: 'Rotation snap increment (deg)',
            min: 0,
            max: 360,
            step: 1,
        });
        registerAdvancedInput(folderLayoutGraph, moleculeOptions.layout.graph, 'rotationSnapDeadzoneDeg', {
            label: 'Rotation snap deadzone (deg)',
            min: 0,
            max: 180,
            step: 1,
        });
        registerAdvancedInput(folderLayoutGraph, moleculeOptions.layout.graph, 'defaultBranchAngleRad', {
            label: 'Default branch angle (rad)',
            min: 0,
            max: Math.PI,
            step: 0.01,
        });
        registerAdvancedInput(folderLayoutGraph, moleculeOptions.layout.graph, 'linearBondToleranceRad', {
            label: 'Linear bond tolerance (rad)',
            min: 0,
            max: 1,
            step: 0.01,
        });
        registerAdvancedInput(folderLayoutGraph, moleculeOptions.layout.graph, 'finetuneRotationOffsetDeg', {
            label: 'Finetune rotation offset (deg)',
            min: 0,
            max: 90,
            step: 0.1,
        });
        registerAdvancedInput(folderLayoutGraph, moleculeOptions.layout.graph, 'centerOfMassRadiusFactor', {
            label: 'Center of mass radius factor',
            min: 0,
            max: 10,
            step: 0.1,
        });
        registerAdvancedInput(folderLayoutGraph, moleculeOptions.layout.graph, 'rotationJitterEpsilon', {
            label: 'Rotation jitter epsilon',
            min: 0,
            max: 0.1,
            step: 0.0001,
        });
        registerAdvancedInput(folderLayoutFinetune, moleculeOptions.layout.finetune, 'enabled', {
            label: 'Enable finetune',
        }, { exclusive: true });
        registerAdvancedInput(folderLayoutFinetune, moleculeOptions.layout.finetune, 'maxSteps', {
            label: 'Finetune max steps',
            min: 0,
            max: 10000,
            step: 1,
        }, { exclusive: true });
        registerAdvancedInput(folderLayoutFinetune, moleculeOptions.layout.finetune, 'maxDurationMs', {
            label: 'Finetune max duration (ms)',
            min: 0,
            max: 10000,
            step: 1,
        }, { exclusive: true });
        registerAdvancedInput(folderLayoutForce, moleculeOptions.layout.force, 'kkThreshold', {
            label: 'KK threshold',
            min: 0,
            max: 1,
            step: 0.01,
        }, { exclusive: true });
        registerAdvancedInput(folderLayoutForce, moleculeOptions.layout.force, 'kkInnerThreshold', {
            label: 'KK inner threshold',
            min: 0,
            max: 1,
            step: 0.01,
        }, { exclusive: true });
        registerAdvancedInput(folderLayoutForce, moleculeOptions.layout.force, 'kkMaxIteration', {
            label: 'KK max iterations',
            min: 0,
            max: 100000,
            step: 10,
        }, { exclusive: true });
        registerAdvancedInput(folderLayoutForce, moleculeOptions.layout.force, 'kkMaxInnerIteration', {
            label: 'KK max inner iterations',
            min: 0,
            max: 5000,
            step: 1,
        }, { exclusive: true });
        registerAdvancedInput(folderLayoutForce, moleculeOptions.layout.force, 'kkMaxEnergy', {
            label: 'KK max energy',
            min: 0,
            max: 1e10,
            step: 1000,
        }, { exclusive: true });
        registerAdvancedInput(folderLayoutForce, moleculeOptions.layout.force, 'hessianMinimum', {
            label: 'Hessian minimum',
            min: 0,
            max: 10,
            step: 0.01,
        }, { exclusive: true });
        registerAdvancedInput(folderLayoutOverlap, moleculeOptions.layout.overlap, 'ringDivisionSegments', {
            label: 'Ring division segments',
            min: 1,
            max: 32,
            step: 1,
        }, { exclusive: true });
        registerAdvancedInput(folderLayoutOverlap, moleculeOptions.layout.overlap, 'finetuneClashDistanceFactor', {
            label: 'Finetune clash distance factor',
            min: 0,
            max: 5,
            step: 0.01,
        }, { exclusive: true });
        registerAdvancedInput(folderLayoutOverlap, moleculeOptions.layout.overlap, 'rotatableEdgeCenteringFactor', {
            label: 'Rotatable edge centering factor',
            min: 0,
            max: 5,
            step: 0.01,
        }, { exclusive: true });
        registerAdvancedInput(folderLayoutOverlap, moleculeOptions.layout.overlap, 'terminalPushAngleDeg', {
            label: 'Terminal push angle (deg)',
            min: 0,
            max: 180,
            step: 1,
        }, { exclusive: true });
        folderLayoutForce.addInput(moleculeOptions.layout.force, 'kkMaxInnerIteration', {
            label: 'KK max inner iterations',
            min: 0,
            max: 5000,
            step: 1,
        });
        folderLayoutForce.addInput(moleculeOptions.layout.force, 'kkMaxEnergy', {
            label: 'KK max energy',
            min: 0,
            max: 1e10,
            step: 1000,
        });
        folderLayoutForce.addInput(moleculeOptions.layout.force, 'hessianMinimum', {
            label: 'Hessian minimum',
            min: 0,
            max: 10,
            step: 0.01,
        });
        folderLayoutOverlap.addInput(moleculeOptions.layout.overlap, 'ringDivisionSegments', {
            label: 'Ring division segments',
            min: 1,
            max: 32,
            step: 1,
        });
        folderLayoutOverlap.addInput(moleculeOptions.layout.overlap, 'finetuneClashDistanceFactor', {
            label: 'Finetune clash distance factor',
            min: 0,
            max: 5,
            step: 0.01,
        });
        folderLayoutOverlap.addInput(moleculeOptions.layout.overlap, 'rotatableEdgeCenteringFactor', {
            label: 'Rotatable edge centering factor',
            min: 0,
            max: 5,
            step: 0.01,
        });
        folderLayoutOverlap.addInput(moleculeOptions.layout.overlap, 'terminalPushAngleDeg', {
            label: 'Terminal push angle (deg)',
            min: 0,
            max: 180,
            step: 1,
        });
        folderTypography.addInput(moleculeOptions.typography, 'fontFamily', {
            label: 'Font family',
        });
        folderTypography.addInput(moleculeOptions.typography, 'fontSizeLarge', {
            label: 'Large font size',
            step: 0.1,
            min: 1.0,
            max: 20.0,
        });
        folderTypography.addInput(moleculeOptions.typography, 'fontSizeSmall', {
            label: 'Small font size',
            step: 0.1,
            min: 1.0,
            max: 20.0,
        });
        folderTypography.addInput(moleculeOptions.typography, 'labelOutlineWidth', {
            label: 'Outline width',
            step: 0.1,
            min: 0,
            max: 10,
        });
        registerAdvancedInput(folderTypography, moleculeOptions.typography, 'svgBaselineShiftEm', {
            label: 'SVG baseline shift (em)',
            step: 0.01,
            min: -2,
            max: 2,
        });
        registerAdvancedInput(folderTypography, moleculeOptions.typography, 'measurementLineHeight', {
            label: 'Measurement line height',
            step: 0.01,
            min: 0,
            max: 5,
        });
        registerAdvancedInput(folderTypography, moleculeOptions.typography, 'isotopeOffsetFactor', {
            label: 'Isotope offset factor',
            step: 0.01,
            min: 0,
            max: 5,
        });
        const folderTypographySpacing = folderTypography.addFolder({
            title: 'Label spacing',
            expanded: false,
        });
        markFolderExclusive(folderTypographySpacing);
        registerAdvancedInput(folderTypographySpacing, moleculeOptions.typography.labelSpacing, 'baseUnitScale', {
            label: 'Base unit scale',
            step: 0.01,
            min: 0,
            max: 5,
        }, { exclusive: true });
        registerAdvancedInput(folderTypographySpacing, moleculeOptions.typography.labelSpacing, 'chargeMultiplier', {
            label: 'Charge multiplier',
            step: 0.01,
            min: -5,
            max: 5,
        });
        registerAdvancedInput(folderTypographySpacing, moleculeOptions.typography.labelSpacing, 'isotopeMultiplier', {
            label: 'Isotope multiplier',
            step: 0.01,
            min: -5,
            max: 5,
        });
        registerAdvancedInput(folderTypographySpacing, moleculeOptions.typography.labelSpacing, 'hydrogenMultiplier', {
            label: 'Hydrogen multiplier',
            step: 0.01,
            min: -5,
            max: 5,
        });
        registerAdvancedInput(folderTypographySpacing, moleculeOptions.typography.labelSpacing, 'hydrogenCountMultiplier', {
            label: 'Hydrogen count multiplier',
            step: 0.01,
            min: -5,
            max: 5,
        });

        folderAppearanceTheme.addInput(moleculeOptions.appearance.themes.custom, 'C', {
            input: 'color',
        });
        folderAppearanceTheme.addInput(moleculeOptions.appearance.themes.custom, 'O', {
            input: 'color',
        });
        folderAppearanceTheme.addInput(moleculeOptions.appearance.themes.custom, 'N', {
            input: 'color',
        });
        folderAppearanceTheme.addInput(moleculeOptions.appearance.themes.custom, 'F', {
            input: 'color',
        });
        folderAppearanceTheme.addInput(moleculeOptions.appearance.themes.custom, 'CL', {
            input: 'color',
        });
        folderAppearanceTheme.addInput(moleculeOptions.appearance.themes.custom, 'BR', {
            input: 'color',
        });
        folderAppearanceTheme.addInput(moleculeOptions.appearance.themes.custom, 'I', {
            input: 'color',
        });
        folderAppearanceTheme.addInput(moleculeOptions.appearance.themes.custom, 'P', {
            input: 'color',
        });
        folderAppearanceTheme.addInput(moleculeOptions.appearance.themes.custom, 'S', {
            input: 'color',
        });
        folderAppearanceTheme.addInput(moleculeOptions.appearance.themes.custom, 'B', {
            input: 'color',
        });
        folderAppearanceTheme.addInput(moleculeOptions.appearance.themes.custom, 'SI', {
            input: 'color',
        });
        folderAppearanceTheme.addInput(moleculeOptions.appearance.themes.custom, 'H', {
            input: 'color',
        });
        folderAppearanceTheme.addInput(moleculeOptions.appearance.themes.custom, 'BACKGROUND', {
            input: 'color',
        });
        const folderVisualizationsWeights = folderVisualizations.addFolder({
            title: 'Weights',
            expanded: false,
        });
        registerAdvancedInput(folderVisualizationsWeights, moleculeOptions.visualizations.weights, 'additionalPadding', {
            label: 'Additional padding',
            min: 0,
            max: 200,
            step: 0.1,
        }, { exclusive: true });
        registerAdvancedInput(folderVisualizationsWeights, moleculeOptions.visualizations.weights, 'sigma', {
            label: 'Sigma',
            min: 0,
            max: 100,
            step: 0.1,
        });
        registerAdvancedInput(folderVisualizationsWeights, moleculeOptions.visualizations.weights, 'interval', {
            label: 'Interval',
            min: -10,
            max: 10,
            step: 0.1,
        });
        registerAdvancedInput(folderVisualizationsWeights, moleculeOptions.visualizations.weights, 'opacity', {
            label: 'Opacity',
            min: 0,
            max: 1,
            step: 0.01,
        });
        const folderVisualizationsGaussian = folderVisualizations.addFolder({
            title: 'Gaussian defaults',
            expanded: false,
        });
        registerAdvancedInput(folderVisualizationsGaussian, moleculeOptions.visualizations.gaussianDefaults, 'defaultSigma', {
            label: 'Default sigma',
            min: 0,
            max: 10,
            step: 0.01,
        }, { exclusive: true });
        registerAdvancedInput(folderVisualizationsGaussian, moleculeOptions.visualizations.gaussianDefaults, 'domainMin', {
            label: 'Domain min',
            min: -10,
            max: 10,
            step: 0.1,
        });
        registerAdvancedInput(folderVisualizationsGaussian, moleculeOptions.visualizations.gaussianDefaults, 'domainMax', {
            label: 'Domain max',
            min: -10,
            max: 10,
            step: 0.1,
        });

        registerAdvancedInput(folderReactionGeneral, reactionOptions, 'spacing', {
            step: 0.1,
            min: 0.0,
            max: 20.0,
        }, { exclusive: true });
        registerAdvancedInput(folderReactionGeneral, reactionOptions, 'fontSize', {
            step: 0.1,
            min: 0.0,
            max: 20.0,
        });
        registerAdvancedInput(folderReactionPlus, reactionOptions.plus, 'size', {
            step: 0.1,
            min: 0.0,
            max: 20.0,
        }, { exclusive: true });
        registerAdvancedInput(folderReactionPlus, reactionOptions.plus, 'thickness', {
            step: 0.1,
            min: 0.0,
            max: 5.0,
        });
        registerAdvancedInput(folderReactionArrow, reactionOptions.arrow, 'length', {
            step: 1,
            min: 0.0,
            max: 500,
        }, { exclusive: true });
        registerAdvancedInput(folderReactionArrow, reactionOptions.arrow, 'thickness', {
            step: 0.1,
            min: 0.1,
            max: 10.0,
        });
        registerAdvancedInput(folderReactionArrow, reactionOptions.arrow, 'headSize', {
            step: 0.1,
            min: 1.0,
            max: 10.0,
        });
        registerAdvancedInput(folderReactionArrow, reactionOptions.arrow, 'margin', {
            step: 0.1,
            min: 0.0,
            max: 10.0,
        });

        const applyCanvasScaleMode = (isDynamic) => {
            if (isDynamic) {
                if (moleculeOptions.canvas.scale > 0) {
                    lastFixedCanvasScale = moleculeOptions.canvas.scale;
                }
                moleculeOptions.canvas.scale = 0.0;
            } else {
                moleculeOptions.canvas.scale = lastFixedCanvasScale > 0 ? lastFixedCanvasScale : 1.0;
            }
            uiState.dynamicCanvasScale = isDynamic;
            dynamicScaleInput.refresh();
            canvasScaleInput.disabled = isDynamic;
            canvasScaleInput.refresh();
        };

        canvasScaleInput.disabled = uiState.dynamicCanvasScale;

        dynamicScaleInput.on('change', (event) => {
            applyCanvasScaleMode(event.value);
        });

        canvasScaleInput.on('change', (event) => {
            if (uiState.dynamicCanvasScale) {
                return;
            }
            if (event.value > 0) {
                lastFixedCanvasScale = event.value;
            } else {
                applyCanvasScaleMode(true);
            }
        });


        const btnExport = folderExport.addButton({
            title: 'Export Settings',
        });

        btnExport.on('click', () => {
            document.getElementById('molecule-options').value = js_beautify(JSON.stringify(moleculeOptions));
            document.getElementById('reaction-options').value = js_beautify(JSON.stringify(reactionOptions));
            document.getElementById('export-modal').classList.add('is-active');
        });

        let input1 = document.getElementById('input-1');
        let input3 = document.getElementById('input-3');

        let themeSelector = document.getElementById('theme-selector');
        let articles = document.querySelectorAll('article.tile');

        input1.addEventListener('input', () => {
            redraw();
        });

        input3.addEventListener('input', () => {
            redraw();
        });

        themeSelector.addEventListener('change', e => {
            theme = e.target.value;
            redraw();
        });

        pane.on('change', e => {
            redraw();
            logCurrentOptions();
        });

        const renderModes = {
            'display-1': 'svg'
        };

        const themeMap = new Map([
            ['light', 'light'],
            ['oldschool', 'light'],
            ['dark', 'dark'],
            ['solarized', 'light'],
            ['solarized-dark', 'dark'],
            ['matrix', 'dark'],
            ['github', 'light'],
            ['carbon', 'light'],
            ['cyberpunk', 'dark'],
            ['gruvbox', 'light'],
            ['gruvbox-dark', 'dark'],
            ['custom', 'light'],
        ]);

        const latestPositionData = {
            display1: null,
        };

        window.getPositionData = function () {
            return {
                display1: latestPositionData.display1,
            };
        };

        function downloadSvg(svgElement, fileName) {
            if (!svgElement) {
                console.warn('downloadSvg: missing svg element');
                return;
            }

            const clone = svgElement.cloneNode(true);

            if (!clone.getAttribute('xmlns')) {
                clone.setAttribute('xmlns', 'http://www.w3.org/2000/svg');
            }

            if (!clone.getAttribute('xmlns:xlink')) {
                clone.setAttribute('xmlns:xlink', 'http://www.w3.org/1999/xlink');
            }

            const svgContent = `<?xml version="1.0" encoding="UTF-8"?>\n${clone.outerHTML}`;
            const blob = new Blob([svgContent], { type: 'image/svg+xml;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = fileName;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            setTimeout(() => URL.revokeObjectURL(url), 0);
        }

        function downloadCanvas(canvasElement, fileName) {
            if (!(canvasElement instanceof HTMLCanvasElement)) {
                console.warn('downloadCanvas: target is not a canvas');
                return;
            }

            try {
                const url = canvasElement.toDataURL('image/png');
                const link = document.createElement('a');
                link.href = url;
                link.download = fileName;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            } catch (err) {
                console.warn('downloadCanvas failed', err);
            }
        }

        function setupDownloadButtons() {
            document.querySelectorAll('.download-button').forEach((button) => {
                const targetSelector = button.getAttribute('data-download-target');

                button.addEventListener('click', () => {
                    if (!targetSelector) {
                        console.warn('download button missing data-download-target attribute');
                        return;
                    }

                                        let targetElement = null;
                    if (targetSelector === 'display-3') {
                        targetElement = document.getElementById('display-3-svg');
                    } else {
                        const mode = renderModes[targetSelector] || 'svg';
                        targetElement = document.getElementById(`${targetSelector}-${mode === 'png' ? 'canvas' : 'svg'}`);
                    }

                    if (!targetElement) {
                        console.warn('download button missing target', targetSelector);
                        return;
                    }

                    const slug = targetSelector.replace(/[^a-z0-9]+/gi, '-').replace(/^-|-$/g, '');
                    if (targetElement instanceof HTMLCanvasElement) {
                        const filename = `${slug || 'diagram'}.png`;
                        downloadCanvas(targetElement, filename);
                    } else {
                        const filename = `${slug || 'diagram'}.svg`;
                        downloadSvg(targetElement, filename);
                    }
                });
            });
        }

        function collectPositionData(drawerInstance) {
            if (!drawerInstance || !drawerInstance.drawer || typeof drawerInstance.drawer.getPositionData !== 'function') {
                return null;
            }

            try {
                return drawerInstance.drawer.getPositionData();
            } catch (err) {
                console.error('collectPositionData error', err);
                return null;
            }
        }

        function updateToggleButtons(displayKey) {
            document.querySelectorAll(`.render-toggle[data-toggle-target=\"${displayKey}\"] button`).forEach((button) => {
                const mode = button.getAttribute('data-render-mode');
                if (!mode) {
                    return;
                }
                if ((renderModes[displayKey] || 'svg') === mode) {
                    button.classList.add('is-link', 'is-selected');
                } else {
                    button.classList.remove('is-link', 'is-selected');
                }
            });
        }

        function setupRenderToggles() {
            document.querySelectorAll('.render-toggle').forEach((group) => {
                const target = group.getAttribute('data-toggle-target');
                if (!target) {
                    return;
                }

                group.querySelectorAll('button').forEach((button) => {
                    button.addEventListener('click', () => {
                        const mode = button.getAttribute('data-render-mode');
                        if (!mode || renderModes[target] === mode) {
                            return;
                        }
                        renderModes[target] = mode === 'png' ? 'png' : 'svg';
                        updateToggleButtons(target);
                        redraw();
                    });
                });

                updateToggleButtons(target);
            });
        }

        function drawAndCollect(smiles, displayKey) {
            const sd = new SmiDrawer(moleculeOptions, reactionOptions);
            const isReaction = smiles.includes('>');
            let targetElement = null;

            if (isReaction || displayKey === 'display-3') {
                const svgElement = document.getElementById(`${displayKey}-svg`);
                if (svgElement) {
                    svgElement.style.display = '';
                }
                const canvasElement = document.getElementById(`${displayKey}-canvas`);
                if (canvasElement) {
                    canvasElement.style.display = 'none';
                }
                targetElement = svgElement;
                if (renderModes[displayKey]) {
                    renderModes[displayKey] = 'svg';
                }
            } else {
                const mode = renderModes[displayKey] || 'svg';
                const svgElement = document.getElementById(`${displayKey}-svg`);
                const canvasElement = document.getElementById(`${displayKey}-canvas`);
                if (svgElement) {
                    svgElement.style.display = mode === 'svg' ? '' : 'none';
                }
                if (canvasElement) {
                    canvasElement.style.display = mode === 'png' ? '' : 'none';
                }
                targetElement = mode === 'png' ? canvasElement : svgElement;
            }

            if (!targetElement) {
                console.warn('Missing render target for', displayKey);
                return null;
            }

            const selector = targetElement.id ? `#${targetElement.id}` : targetElement;

            try {
                sd.draw(smiles, selector, theme);
                return collectPositionData(sd);
            } catch (err) {
                console.error(err);
                return null;
            }
        }

        function redraw() {
            ['display-1', 'display-3'].forEach((key) => {
                const svgElement = document.getElementById(`${key}-svg`);
                if (svgElement) {
                    svgElement.style.width = '';
                    svgElement.style.height = '';
                }
                const canvasElement = document.getElementById(`${key}-canvas`);
                if (canvasElement) {
                    canvasElement.style.width = '';
                    canvasElement.style.height = '';
                    const targetWidth = canvasElement.width || 500;
                    const targetHeight = canvasElement.height || 500;
                    canvasElement.width = targetWidth;
                    canvasElement.height = targetHeight;
                }
            });

            const data1 = drawAndCollect(input1.value, 'display-1');
            drawAndCollect(input3.value, 'display-3');

            latestPositionData.display1 = data1;

            if (themeMap.get(theme) === 'light') {
                articles.forEach(a => {
                    a.classList.remove('is-dark');
                });
            } else {
                articles.forEach(a => {
                    a.classList.add('is-dark');
                });
            }
        }

        setupRenderToggles();
        redraw();
        setupDownloadButtons();

        // Close modals
        (document.querySelectorAll('.modal-background, .modal-close, .modal-card-head .delete, .modal-card-foot .button') || []).forEach((close) => {
            const target = close.closest('.modal');

            close.addEventListener('click', () => {
                target.classList.remove('is-active');
            });
        });
    </script>
</body>

</html>
